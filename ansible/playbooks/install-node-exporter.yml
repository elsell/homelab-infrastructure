---
- hosts: ubuntu_vms,k8s_nodes
  become: true
  tasks:
    - name: Install node-exporter and ufw
      apt:
        name:
          - prometheus-node-exporter
          - ufw
        state: present
        update_cache: yes

    - name: Allow SSH through firewall (prevent lockout)
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow node-exporter from Prometheus mini PC only
      ufw:
        rule: allow
        port: '9100'
        proto: tcp
        from_ip: 192.168.2.228

    - name: Enable firewall
      ufw:
        state: enabled

    - name: Enable and start node-exporter
      systemd:
        name: prometheus-node-exporter
        enabled: yes
        state: started
